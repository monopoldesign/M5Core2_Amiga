/******************************************************************************
* M5Core2_Amiga
* (C)2021 M.Volkel
*
* Main-Program
*******************************************************************************/

// Comment templates

/******************************************************************************
*
*******************************************************************************/

/*------------------------------------------------------------------------------
-
------------------------------------------------------------------------------*/

/******************************************************************************/

/******************************************************************************
* Header-Files
*******************************************************************************/
#include <M5Core2.h>

#include "main.h"
#include "M5RTC.h"
#include "M5Settings.h"
#include "M5Wifi.h"
#include "gui/gui.h"
#include "frame/frame.h"

/******************************************************************************
* Global Variables
*******************************************************************************/
char buffer[16];

/******************************************************************************
* Functions
*******************************************************************************/

/*------------------------------------------------------------------------------
- setup()
------------------------------------------------------------------------------*/
void setup()
{
	m5set_initSettings();

	if (!SPIFFS.begin())
	{
		Serial.println("Failed to open SPIFFS");
		return;
	}

	M5.begin();

	M5.Axp.SetSpkEnable(true);
	M5.Axp.SetLed(0);
	M5.Lcd.clear(M5.Lcd.color565(149, 149, 149));
	m5set_loadSettings();

	m5wifi_scanWifi();
	m5wifi_findWifi();
	m5wifi_printWifiList();

	if (m5wifi_setWifi())
	{
		Serial.print("Connecting to: ");
		Serial.print(globalSettings->wifiSsid);
		Serial.print(" using Pwd:");
		Serial.print(globalSettings->wifiPwd);
		Serial.println();

		m5wifi_initWifi();
		m5wifi_getNTPTime();
	}
	else
	{
		m5rtc_getTime();
		Serial.println("Couldn't connect to WiFi!");
	}

	Frame_Main *frame_main = new Frame_Main();
	GUI_PushFrame(frame_main);
}

/*------------------------------------------------------------------------------
-
------------------------------------------------------------------------------*/
void loop()
{
	GUI_MainLoop();
}
